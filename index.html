<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grippo Admin — Exercise Examples</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#0f1524;--panel-2:#0b1220;--text:#e5e7eb;--muted:#9aa6b2;
      --brand:#60a5fa;--brand-2:#38bdf8;--danger:#ef4444;--ok:#22c55e;--border:#1b2433;
      --warning:#f59e0b;--shadow:0 10px 32px rgba(0,0,0,.45);
      --field:#0a1222;--field-hover:#0c1630;--field-focus:#0e1b3a;
      --header-bg:#0a1a33;--divider:#0f233e;
      --section-gap:18px;--block-gap:14px;
      --select-arrow:#e5e7eb;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,var(--bg),#0a0f1a);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color-scheme: dark;
    }

    /* Header visually distinct */
    header{
      position:sticky;top:0;z-index:20;backdrop-filter:blur(6px);
      background:linear-gradient(180deg,var(--header-bg) 75%, rgba(0,0,0,0));
      border-bottom:1px solid var(--border);padding:12px 14px;
      display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;
      box-shadow:0 8px 26px rgba(0,0,0,.35)
    }
    .token-input{width:100%}

    /* Inputs — dark only */
    input[type="password"],input[type="text"],input[type="search"],input[type="url"],input[type="number"],select,textarea{
      width:100%;background:var(--field)!important;border:1px solid var(--border);color:var(--text)!important;
      border-radius:12px;padding:11px 12px;outline:none;
      transition:border .15s, box-shadow .15s, background .15s, transform .02s;
      -webkit-text-fill-color: var(--text);
    }
    /* Custom select arrow + right padding so arrow isn't glued to edge */
    select{
      appearance:none;-webkit-appearance:none; -moz-appearance:none;
      padding-right:38px;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 20 20" fill="%23e5e7eb"><path d="M5.5 7l4.5 6 4.5-6H5.5z"/></svg>');
      background-repeat:no-repeat;background-position:right 12px center;background-size:12px 12px;
    }
    select::-ms-expand{display:none}

    input::placeholder,textarea::placeholder{color:var(--muted)}
    input:hover,textarea:hover,select:hover{background:var(--field-hover)!important}
    input:focus,textarea:focus,select:focus{
      background:var(--field-focus)!important;border-color:#2a436f;
      box-shadow:0 0 0 3px rgba(96,165,250,.12), inset 0 0 0 1px rgba(96,165,250,.08)
    }

    /* Kill white autofill */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    select:-webkit-autofill,
    textarea:-webkit-autofill{
      -webkit-text-fill-color: var(--text);
      -webkit-box-shadow: 0 0 0px 1000px var(--field-focus) inset;
      transition: background-color 9999s ease-in-out 0s;
      caret-color: var(--text);
    }

    /* Number inputs */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    input[type=number]{ -moz-appearance:textfield }

    .btn{
      background:linear-gradient(90deg,var(--brand),var(--brand-2));border:0;color:#fff;padding:11px 14px;border-radius:12px;cursor:pointer;
      box-shadow:var(--shadow);transition:transform .05s, filter .15s;font-weight:600
    }
    .btn:hover{filter:brightness(1.05)}
    .btn.muted{background:var(--panel-2);color:var(--text);border:1px solid var(--border);box-shadow:none}
    .btn.warn{background:var(--warning);color:#111}
    .btn.ghost{background:transparent;border:1px dashed var(--border)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn:active{transform:translateY(1px)}

    main{display:grid;grid-template-columns:340px 1fr;gap:14px;padding:14px;min-height:calc(100% - 74px)}
    @media (max-width:1000px){main{grid-template-columns:1fr}}

    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;min-height:0}
    .side-head{padding:14px;display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;border-bottom:1px solid var(--border)}
    .list{overflow:auto;padding:10px;display:grid;gap:10px}
    .item{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;display:grid;gap:6px;transition:border .15s, background .15s}
    .item:hover{border-color:#2b394f;background:#0c1730}
    .item.active{outline:2px solid var(--brand)}
    .name{font-weight:700}.meta{color:var(--muted);font-size:12px;display:flex;gap:10px;align-items:center}
    .pill{background:#09213b;color:#9fd2ff;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #102e4e}

    /* Editor container: no card bg/radius per request */
    .panel{background:transparent;border:0;border-radius:0;display:flex;flex-direction:column;min-height:0}
    .ed-head{padding:12px;display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--border);flex-wrap:wrap;background:var(--panel)}
    .spacer{flex:1}
    .status{font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel-2)}
    .status.ok{color:#d1fae5;background:#08351a;border-color:#14532d}
    .status.bad{color:#fee2e2;background:#3a0d0d;border-color:#7f1d1d}
    .status.warn{color:#fff7ed;background:#3a270b;border-color:#92400e}

    .view-toggle{display:flex;gap:8px;margin-left:auto}
    .segment{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:6px;display:inline-flex;gap:6px}
    .segment .seg{background:transparent;border:0;color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
    .segment .seg.active{background:var(--panel);border:1px solid var(--border)}

    .builder{padding:16px;display:none}.builder.show{display:block}

    /* Sections + dividers + spacing */
    .section{display:grid;gap:var(--block-gap);margin-bottom:var(--section-gap)}
    .section-title{font-weight:800;letter-spacing:.2px}
    .divider{height:1px;background:linear-gradient(90deg,rgba(255,255,255,.05),var(--divider),rgba(255,255,255,.05));border:0;margin:8px 0 0}

    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .field{display:grid;gap:6px}
    .field label{font-weight:600}
    .hint{font-size:12px;color:var(--muted)}
    .invalid{border-color:#7f1d1d !important;box-shadow:inset 0 0 0 1px #7f1d1d}

    .token-list{display:flex;flex-wrap:wrap;gap:8px}
    .token{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;background:#0a1c36;color:#bfe1ff;border:1px solid #12355e;border-radius:999px;font-size:12px}
    .token button{background:transparent;border:0;color:#bfe1ff;cursor:pointer;font-size:14px;line-height:1}
    .token.invalid{border-color:#7f1d1d;color:#fecaca;background:#3a0d0d}

    .bundle-row{display:grid;grid-template-columns:1.6fr 0.6fr auto;gap:8px;align-items:center}
    .sum{font-size:12px}
    .sum.bad{color:#fca5a5}.sum.ok{color:#86efac}

    textarea#editor{
      width:100%;min-height:320px;resize:vertical;border:1px solid var(--border);outline:none;margin:16px;padding:16px;background:#0a1324;color:#dbeafe;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px;line-height:1.5;border-radius:12px
    }

    .toast{position:fixed;right:16px;bottom:16px;background:var(--panel-2);border:1px solid var(--border);color:var(--text);
      padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);min-width:220px;display:grid;gap:6px}
    .toast.success{border-color:#155e31;background:#0a2a18}
    .toast.error{border-color:#7f1d1d;background:#3a0d0d}
    .toast .title{font-weight:700}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="token-input">
      <input id="token" type="password" placeholder="Bearer token (stored locally)" autocomplete="off"/>
    </div>
    <button id="saveToken" class="btn muted" title="Save token to localStorage">Save token</button>
    <button id="loadBtn" class="btn" title="Fetch list from API">Load list</button>
  </header>

  <main>
    <!-- Single module -->
    <section class="sidebar" aria-label="Examples list">
      <div class="side-head">
        <input id="search" type="search" placeholder="Search by name…"/>
        <button id="newBtn" class="btn warn" title="Create new exercise example">New</button>
        <button id="clearSearch" class="btn muted" title="Clear">×</button>
      </div>
      <div id="list" class="list" role="listbox" aria-label="Exercise examples list"></div>
    </section>

    <section class="panel">
      <div class="ed-head">
        <span id="currentId" class="hint">No item selected</span>
        <span class="spacer"></span>
        <span id="jsonStatus" class="status warn">Waiting…</span>

        <div class="view-toggle">
          <div class="segment" role="tablist" aria-label="Editor mode">
            <button id="viewForm" class="seg active" role="tab" aria-selected="true" title="Form builder">Form</button>
            <button id="viewJson" class="seg" role="tab" aria-selected="false" title="Raw JSON">JSON</button>
          </div>
        </div>

        <button id="formatBtn" class="btn muted" title="Prettify JSON">Format</button>
        <button id="copyEntityBtn" class="btn muted" title="Copy editor JSON">Copy editor JSON</button>
        <button id="copyFullBtn" class="btn muted" title="Copy full item (entity + stats)">Copy full JSON</button>
        <button id="promptBtn" class="btn" title="Build GPT prompt from dictionaries + current JSON">Build GPT prompt</button>
        <button id="saveBtn" class="btn" disabled title="Save changes">Save</button>
      </div>

      <!-- FORM BUILDER -->
      <div id="builder" class="builder show" aria-label="Exercise Example Builder">

        <!-- Identifier at the very top -->
        <div class="section">
          <div class="section-title">Identifier</div>
          <div class="field">
            <label for="fId">ID (locked for existing)</label>
            <input id="fId" type="text" disabled placeholder="Auto for new, locked for existing"/>
            <div class="hint">ID cannot be changed for existing items.</div>
          </div>
          <hr class="divider"/>
        </div>

        <!-- Basics -->
        <div class="section">
          <div class="section-title">Basics</div>
          <div class="grid two">
            <div class="field">
              <label for="fName">Name *</label>
              <input id="fName" type="text" placeholder="e.g., Bench Press"/>
            </div>
            <div class="field">
              <label for="fImage">Image URL (optional)</label>
              <input id="fImage" type="url" placeholder="https://..."/>
              <div class="hint">If empty, you can still save; it will show a warning.</div>
            </div>
          </div>
          <div class="field">
            <label for="fDescription">Description *</label>
            <textarea id="fDescription" rows="3" placeholder="Short description..."></textarea>
          </div>
          <hr class="divider"/>
        </div>

        <!-- Attributes: 2 fields per row -->
        <div class="section">
          <div class="section-title">Attributes</div>

          <div class="grid two">
            <div class="field">
              <label for="fWeightType">Weight type *</label>
              <select id="fWeightType">
                <option value="">— select —</option>
                <option value="free">free</option>
                <option value="fixed">fixed</option>
                <option value="body_weight">body_weight</option>
              </select>
            </div>
            <div class="field">
              <label for="fCategory">Category *</label>
              <select id="fCategory">
                <option value="">— select —</option>
                <option value="compound">compound</option>
                <option value="isolation">isolation</option>
              </select>
            </div>
          </div>

          <div class="grid two">
            <div class="field">
              <label for="fExperience">Experience *</label>
              <select id="fExperience">
                <option value="">— select —</option>
                <option value="beginner">beginner</option>
                <option value="intermediate">intermediate</option>
                <option value="advanced">advanced</option>
                <option value="pro">pro</option>
              </select>
            </div>
            <div class="field">
              <label for="fForceType">Force type *</label>
              <select id="fForceType">
                <option value="">— select —</option>
                <option value="push">push</option>
                <option value="pull">pull</option>
                <option value="hinge">hinge</option>
              </select>
            </div>
          </div>
          <hr class="divider"/>
        </div>

        <!-- Equipment -->
        <div class="section">
          <div class="section-title">Equipment *</div>
          <div id="equipTokens" class="token-list" aria-live="polite"></div>

          <div class="grid two">
            <div class="field">
              <label for="equipSelect">Select equipment</label>
              <select id="equipSelect" size="6" multiple></select>
              <div class="hint">Use Ctrl/Cmd or Shift to multi-select. Stored as <code>{ equipmentId }</code>.</div>
            </div>
            <div class="field" style="align-content:start;gap:8px">
              <button id="equipAdd" class="btn" type="button">Add selected</button>
              <button id="equipClear" class="btn muted" type="button">Clear all</button>
            </div>
          </div>

          <hr class="divider"/>
        </div>

        <!-- Muscles -->
        <div class="section">
          <div class="section-title">Muscle bundles (sum must be 100%) *</div>

          <div id="bundles" style="display:grid;gap:8px"></div>

          <div class="bundle-row">
            <select id="muscleSelect"></select>
            <input id="percentInput" type="number" min="0" max="100" step="1" placeholder="%"/>
            <button id="bundleAdd" class="btn" type="button">Add bundle</button>
          </div>
          <div id="bundleSumInfo" class="sum">Sum: 0%</div>
        </div>
      </div>

      <!-- RAW JSON -->
      <textarea id="editor" spellcheck="false" hidden></textarea>
    </section>
  </main>

  <template id="itemTemplate">
    <div class="item" role="option" tabindex="0">
      <div class="name"></div>
      <div class="meta">
        <span class="pill usage"></span>
        <span class="lastUsed"></span>
      </div>
    </div>
  </template>

  <script>
    // ===== Configuration =====
    const API_BASE = 'https://grippo-app.com';
    const LIST_ENDPOINT   = `${API_BASE}/exercise-examples`;
    const CREATE_ENDPOINT = `${API_BASE}/exercise-examples`;
    const PUT_ENDPOINT    = (id) => `${API_BASE}/exercise-examples?id=${encodeURIComponent(id)}`;

    const EQUIPMENT_GROUPS_ENDPOINT = `${API_BASE}/equipments`;
    const MUSCLE_GROUPS_ENDPOINT    = `${API_BASE}/muscles`;

    // ===== State =====
    let items = [];
    let filtered = [];
    let current = null;
    let isNew = false;

    // DTO fields
    const FIELD = {
      equipmentRefs: 'equipmentRefs',
      bundles: 'exerciseExampleBundles',
      muscleId: 'muscleId',
      percentage: 'percentage'
    };

    // Dictionaries (id -> name)
    const dict = { equipment: new Map(), muscles: new Map() };
    const dictIndex = { equipmentByName: new Map(), musclesByName: new Map() };
    const normalizeName = (s)=> String(s||'').trim().toLowerCase();
    function rebuildNameIndexes(){
      dictIndex.equipmentByName.clear();
      for (const [id, name] of dict.equipment) dictIndex.equipmentByName.set(normalizeName(name), id);
      dictIndex.musclesByName.clear();
      for (const [id, name] of dict.muscles) dictIndex.musclesByName.set(normalizeName(name), id);
    }

    // ===== Elements =====
    const els = {
      token: document.getElementById('token'),
      saveToken: document.getElementById('saveToken'),
      load: document.getElementById('loadBtn'),

      list: document.getElementById('list'),
      search: document.getElementById('search'),
      clearSearch: document.getElementById('clearSearch'),
      newBtn: document.getElementById('newBtn'),

      currentId: document.getElementById('currentId'),
      jsonStatus: document.getElementById('jsonStatus'),
      saveBtn: document.getElementById('saveBtn'),
      formatBtn: document.getElementById('formatBtn'),
      copyEntityBtn: document.getElementById('copyEntityBtn'),
      copyFullBtn: document.getElementById('copyFullBtn'),
      promptBtn: document.getElementById('promptBtn'),

      viewForm: document.getElementById('viewForm'),
      viewJson: document.getElementById('viewJson'),
      builder: document.getElementById('builder'),
      editor: document.getElementById('editor'),

      fName: document.getElementById('fName'),
      fImage: document.getElementById('fImage'),
      fDescription: document.getElementById('fDescription'),
      fWeightType: document.getElementById('fWeightType'),
      fCategory: document.getElementById('fCategory'),
      fExperience: document.getElementById('fExperience'),
      fForceType: document.getElementById('fForceType'),
      fId: document.getElementById('fId'),

      equipTokens: document.getElementById('equipTokens'),
      equipSelect: document.getElementById('equipSelect'),
      equipAdd: document.getElementById('equipAdd'),
      equipClear: document.getElementById('equipClear'),

      bundles: document.getElementById('bundles'),
      muscleSelect: document.getElementById('muscleSelect'),
      percentInput: document.getElementById('percentInput'),
      bundleAdd: document.getElementById('bundleAdd'),
      bundleSumInfo: document.getElementById('bundleSumInfo'),

      itemTemplate: document.getElementById('itemTemplate'),
    };

    // ===== Utilities =====
    function toast({title, message = '', type = 'success', ms = 3000}) {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<div class="title">${title}</div>${message ? `<div>${message}</div>` : ''}`;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), ms);
    }
    function saveTokenLocal(v){ localStorage.setItem('grippo_admin_token', v || ''); }
    function loadTokenLocal(){ return localStorage.getItem('grippo_admin_token') || ''; }
    function bearer(){ const tok = els.token.value.trim(); return tok ? {'Authorization': `Bearer ${tok}`} : {}; }
    function pretty(json){ return JSON.stringify(json, null, 2); }
    function formatIso(d){ try{ return new Date(d).toISOString().replace('T',' ').replace('Z','Z'); }catch{ return String(d); } }
    function setStatus(kind, text){ els.jsonStatus.className = `status ${kind}`; els.jsonStatus.textContent = text; }
    function uuidv4(){
      if (crypto?.randomUUID) return crypto.randomUUID();
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
        const r=(Math.random()*16)|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
      });
    }

    // ===== Dictionaries =====
    async function fetchEquipmentDict(){
      try{
        const resp = await fetch(EQUIPMENT_GROUPS_ENDPOINT, {headers:{accept:'application/json'}});
        if(!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
        const data = await resp.json();
        const equipments = [];
        if (Array.isArray(data) && data.length && Array.isArray(data[0]?.equipments)){
          data.forEach(g => (g.equipments||[]).forEach(e => equipments.push(e)));
        } else if (Array.isArray(data)){
          data.forEach(e => equipments.push(e));
        }
        for (const e of equipments){
          if (e?.id) dict.equipment.set(String(e.id), String(e.name ?? e.id));
        }
      }catch(e){ console.warn('Equipment dict fetch failed:', e); }
    }
    async function fetchMuscleDict(){
      try{
        const resp = await fetch(MUSCLE_GROUPS_ENDPOINT, {headers:{accept:'application/json'}});
        if(!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
        const data = await resp.json();
        if (Array.isArray(data)){
          for (const g of data){
            (g.muscles||[]).forEach(m => { if (m?.id) dict.muscles.set(String(m.id), String(m.name ?? m.id)); });
          }
        }
      }catch(e){ console.warn('Muscle dict fetch failed:', e); }
    }
    function refreshOptionLists(){
      els.equipSelect.innerHTML = '';
      for (const [id,name] of dict.equipment.entries()){
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = `${name} — ${id}`;
        els.equipSelect.appendChild(opt);
      }
      els.muscleSelect.innerHTML = '';
      for (const [id,name] of dict.muscles.entries()){
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = `${name} — ${id}`;
        els.muscleSelect.appendChild(opt);
      }
    }

    // ===== Sidebar =====
    function renderList(){
      els.list.innerHTML = '';
      const frag = document.createDocumentFragment();
      filtered.forEach(it=>{
        const node = els.itemTemplate.content.firstElementChild.cloneNode(true);
        const entity = it.entity;
        node.querySelector('.name').textContent = entity?.name || '(no name)';
        node.querySelector('.usage').textContent = `used ${it.usageCount ?? 0}`;
        node.querySelector('.lastUsed').textContent = it.lastUsed ? `last: ${formatIso(it.lastUsed)}` : 'last: —';
        node.addEventListener('click', ()=>selectItem(it));
        node.addEventListener('keydown', e=>{
          if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectItem(it); }
        });
        if (current && current.entity?.id === entity?.id) node.classList.add('active');
        frag.appendChild(node);
      });
      els.list.appendChild(frag);
    }
    function applySearch(){
      const q = els.search.value.trim().toLowerCase();
      filtered = !q ? items.slice() : items.filter(it => (it.entity?.name || '').toLowerCase().includes(q));
      renderList();
    }

    // ===== Canonical entity (DTO) =====
    function emptyTemplate(){
      return {
        id: uuidv4(),
        name: '',
        description: '',
        weightType: '',
        category: '',
        experience: '',
        forceType: '',
        imageUrl: '',
        [FIELD.bundles]: [],
        [FIELD.equipmentRefs]: [],
        tutorials: []
      };
    }
    function normalizeEntityShape(src){
      const e = {...src};
      const eq = Array.isArray(e[FIELD.equipmentRefs]) ? e[FIELD.equipmentRefs] : [];
      e[FIELD.equipmentRefs] = eq.map(x=>{
        if (typeof x === 'string') return { equipmentId: x };
        if (x && typeof x === 'object') {
          const id = x.equipmentId ?? x.id ?? x.key ?? x.code;
          return id ? { equipmentId: String(id) } : null;
        }
        return null;
      }).filter(Boolean);
      const rawB = Array.isArray(e[FIELD.bundles]) ? e[FIELD.bundles] : [];
      e[FIELD.bundles] = rawB.map(b=>{
        if (!b || typeof b !== 'object') return null;
        const muscleId = String(b.muscleId ?? b.muscle ?? b.muscle_id ?? b.targetMuscleId ?? '').trim();
        const percentage = Number(b.percentage ?? b.percent ?? b.ratio ?? b.load ?? 0);
        if (!muscleId || !isFinite(percentage)) return null;
        return { muscleId, percentage };
      }).filter(Boolean);
      if (!Array.isArray(e.tutorials)) e.tutorials = [];
      return e;
    }
    let canonical = emptyTemplate();
    function getEntity(){ return {...canonical}; }
    function setEntity(newEnt){
      canonical = {...newEnt};
      writeEntityToForm(canonical);
      els.editor.value = pretty(canonical);
      validateAll();
    }

    // ===== Form sync =====
    function readFormToEntity(entity){
      const e = {...entity};
      e.name = els.fName.value.trim();
      e.imageUrl = els.fImage.value.trim();
      e.description = els.fDescription.value.trim();
      e.weightType = els.fWeightType.value;
      e.category = els.fCategory.value;
      e.experience = els.fExperience.value;
      e.forceType = els.fForceType.value;
      if (!Array.isArray(e.tutorials)) e.tutorials = [];
      return e;
    }
    function writeEntityToForm(entity){
      els.fId.value = entity?.id || '';
      els.fName.value = entity?.name || '';
      els.fImage.value = entity?.imageUrl || '';
      els.fDescription.value = entity?.description || '';
      els.fWeightType.value = entity?.weightType || '';
      els.fCategory.value = entity?.category || '';
      els.fExperience.value = entity?.experience || '';
      els.fForceType.value = entity?.forceType || '';
      renderEquipmentTokens(entity);
      renderBundles(entity);
    }

    // ===== Equipment UI =====
    function renderEquipmentTokens(entity){
      const eq = Array.isArray(entity[FIELD.equipmentRefs]) ? entity[FIELD.equipmentRefs] : [];
      els.equipTokens.innerHTML = '';
      const frag = document.createDocumentFragment();
      eq.forEach((obj, idx)=>{
        const id = String(obj?.equipmentId || '');
        const name = dict.equipment.get(id) || id;
        const t = document.createElement('span');
        t.className = 'token';
        if (!dict.equipment.has(id)) t.classList.add('invalid');
        t.innerHTML = `<span>${name}</span>`;
        const btn = document.createElement('button'); btn.type='button'; btn.textContent='×'; btn.title='Remove';
        btn.addEventListener('click', ()=>{
          const ent = getEntity(); const arr = ent[FIELD.equipmentRefs] || [];
          arr.splice(idx,1); ent[FIELD.equipmentRefs] = arr; setEntity(ent);
        });
        t.appendChild(btn); frag.appendChild(t);
      });
      els.equipTokens.appendChild(frag);
    }
    function addSelectedEquipments(){
      const selected = Array.from(els.equipSelect.selectedOptions).map(o=>o.value);
      if (!selected.length){ toast({title:'Nothing selected', type:'error'}); return; }
      const ent = getEntity();
      if (!Array.isArray(ent[FIELD.equipmentRefs])) ent[FIELD.equipmentRefs] = [];
      for (const id of selected){
        if (!dict.equipment.has(id)) continue;
        if (!ent[FIELD.equipmentRefs].some(x => x.equipmentId === id)) {
          ent[FIELD.equipmentRefs].push({ equipmentId: id });
        }
      }
      setEntity(ent);
      els.equipSelect.selectedIndex = -1;
    }

    // ===== Bundles UI =====
    function renderBundles(entity){
      const arr = Array.isArray(entity[FIELD.bundles]) ? entity[FIELD.bundles] : [];
      els.bundles.innerHTML = '';
      const frag = document.createDocumentFragment();
      let sum = 0;

      arr.forEach((b, i)=>{
        const row = document.createElement('div'); row.className='bundle-row';

        const muscle = document.createElement('select');
        for (const [id,name] of dict.muscles.entries()){
          const opt = document.createElement('option');
          opt.value=id; opt.textContent=`${name} — ${id}`;
          if (String(b?.muscleId||'')===id) opt.selected=true;
          muscle.appendChild(opt);
        }
        if (!dict.muscles.has(String(b?.muscleId||''))) muscle.classList.add('invalid');

        const percent = document.createElement('input');
        percent.type='number'; percent.min='0'; percent.max='100'; percent.step='1'; percent.placeholder='%';
        const p = Number(b?.percentage ?? 0); percent.value = String(p);
        if (!isFinite(p) || p<0 || p>100) percent.classList.add('invalid');
        sum += isFinite(p) ? p : 0;

        const del = document.createElement('button'); del.className='btn muted'; del.type='button'; del.textContent='Remove';

        muscle.addEventListener('change', ()=>{
          const ent = getEntity();
          ent[FIELD.bundles][i].muscleId = muscle.value;
          setEntity(ent);
        });
        percent.addEventListener('change', ()=>{
          const ent = getEntity();
          ent[FIELD.bundles][i].percentage = Number(percent.value || 0);
          setEntity(ent);
        });
        del.addEventListener('click', ()=>{
          const ent = getEntity(); ent[FIELD.bundles].splice(i,1); setEntity(ent);
        });

        row.appendChild(muscle); row.appendChild(percent); row.appendChild(del);
        frag.appendChild(row);
      });

      els.bundles.appendChild(frag);
      els.bundleSumInfo.textContent = `Sum: ${sum}%`;
      els.bundleSumInfo.className = 'sum ' + (sum===100?'ok':'bad');

      if (!els.muscleSelect.options.length){
        for (const [id,name] of dict.muscles.entries()){
          const opt = document.createElement('option'); opt.value=id; opt.textContent=`${name} — ${id}`;
          els.muscleSelect.appendChild(opt);
        }
      }
    }
    function addBundleFromInputs(){
      const muscleId = els.muscleSelect.value;
      const p = Number(els.percentInput.value || 0);
      if (!muscleId || !isFinite(p)){ toast({title:'Select muscle and %', type:'error'}); return; }
      if (!dict.muscles.has(muscleId)){ toast({title:'Unknown muscle', type:'error'}); return; }

      const ent = getEntity();
      if (!Array.isArray(ent[FIELD.bundles])) ent[FIELD.bundles] = [];
      ent[FIELD.bundles].push({ muscleId, percentage: p });
      setEntity(ent);
      els.percentInput.value='';
    }

    // ===== Selection & CRUD =====
    function selectItem(it){
      current = it; isNew = false;
      const e = it.entity || emptyTemplate();
      canonical = normalizeEntityShape(e);
      els.currentId.textContent = canonical?.id ? `Editing ID: ${canonical.id}` : 'Editing: unknown ID';
      writeEntityToForm(canonical);
      els.editor.value = pretty(canonical);
      validateAll();
      renderList();
    }
    function newItem(){
      current = null; isNew = true;
      canonical = emptyTemplate();
      els.currentId.textContent = `Creating new ID: ${canonical.id}`;
      writeEntityToForm(canonical);
      els.editor.value = pretty(canonical);
      validateAll();
    }

    async function loadList(){
      const headers = {accept:'application/json', ...bearer()};
      if (!headers.Authorization){
        toast({title:'Token required', message:'Set a valid Bearer token first.', type:'error', ms:3500}); return;
      }
      els.load.disabled = true;
      try{
        const resp = await fetch(LIST_ENDPOINT, {headers, method:'GET'});
        if(!resp.ok){
          const text = await resp.text(); throw new Error(`${resp.status} ${resp.statusText} — ${text.slice(0,300)}`);
        }
        const data = await resp.json();
        if(!Array.isArray(data)) throw new Error('Unexpected response shape: expected an array');
        items = data; filtered = items.slice();
        renderList(); toast({title:'Loaded', message:`Items: ${items.length}`});
      }catch(e){
        toast({title:'Load failed', message:String(e.message||e), type:'error', ms:6000}); console.error(e);
      }finally{ els.load.disabled = false; }
    }

    async function saveCurrent(){
      const headers = {'accept':'application/json','content-type':'application/json', ...bearer()};
      if (!headers.Authorization){ toast({title:'Token required', message:'Set a valid Bearer token first.', type:'error'}); return; }

      const ent = readFormToEntity(getEntity());
      setEntity(ent);
      const {ok} = validateAll();
      if (!ok){ toast({title:'Fix validation errors', type:'error'}); return; }

      els.saveBtn.disabled = true;
      try{
        if (isNew){
          let resp = await fetch(CREATE_ENDPOINT, {method:'POST', headers, body: JSON.stringify(canonical)});
          if (!resp.ok){
            resp = await fetch(PUT_ENDPOINT(canonical.id), {method:'PUT', headers, body: JSON.stringify(canonical)});
          }
          if (!resp.ok){
            const text = await resp.text(); throw new Error(`${resp.status} ${resp.statusText} — ${text.slice(0,400)}`);
          }
          toast({title:'Created', message:`ID ${canonical.id}`});
          isNew = false;
          await loadList();
        }else{
          canonical.id = current?.entity?.id || canonical.id; // lock ID
          const id = canonical.id;
          const resp = await fetch(PUT_ENDPOINT(id), {method:'PUT', headers, body: JSON.stringify(canonical)});
          if (!resp.ok){
            const text = await resp.text(); throw new Error(`${resp.status} ${resp.statusText} — ${text.slice(0,400)}`);
          }
          toast({title:'Saved', message:`ID ${id} updated.`});
          if (current) current.entity = {...canonical};
          renderList();
        }
      }catch(e){
        toast({title:'Save failed', message:String(e.message||e), type:'error', ms:7000}); console.error(e);
      }finally{ els.saveBtn.disabled = false; }
    }

    // ===== Validation (imageUrl -> warning only) =====
    function validateAll(){
      const ent = getEntity();

      const errors = [];
      const warnings = [];

      if (!ent.name) errors.push('Missing: name');
      if (!ent.description) errors.push('Missing: description');
      if (!ent.weightType) errors.push('Missing: weightType');
      if (!ent.category) errors.push('Missing: category');
      if (!ent.experience) errors.push('Missing: experience');
      if (!ent.forceType) errors.push('Missing: forceType');

      if (!ent.imageUrl) warnings.push('imageUrl is empty');

      const weightOk = ['free','fixed','body_weight'].includes(ent.weightType);
      const catOk = ['compound','isolation'].includes(ent.category);
      const expOk = ['beginner','intermediate','advanced','pro'].includes(ent.experience);
      const forceOk = ['push','pull','hinge'].includes(ent.forceType);
      if (ent.weightType && !weightOk) errors.push('weightType invalid');
      if (ent.category && !catOk) errors.push('category invalid');
      if (ent.experience && !expOk) errors.push('experience invalid');
      if (ent.forceType && !forceOk) errors.push('forceType invalid');

      const eq = Array.isArray(ent[FIELD.equipmentRefs]) ? ent[FIELD.equipmentRefs] : [];
      if (eq.length === 0) errors.push('No equipment selected');
      const unknownEq = eq.map(x=>String(x?.equipmentId||'')).filter(id => !dict.equipment.has(id));
      if (unknownEq.length) errors.push(`Unknown equipment: ${Array.from(new Set(unknownEq)).join(', ')}`);

      const bundles = Array.isArray(ent[FIELD.bundles]) ? ent[FIELD.bundles] : [];
      if (bundles.length === 0) errors.push('No muscle bundles added');
      let sum = 0, outOfRange = false; const unknownMuscles = [];
      for (const b of bundles){
        const id = String(b?.muscleId ?? '');
        const p  = Number(b?.percentage ?? 0);
        if (!isFinite(p) || p<0 || p>100) outOfRange = true;
        sum += isFinite(p)? p : 0;
        if (!dict.muscles.has(id)) unknownMuscles.push(id);
      }
      if (sum !== 100) errors.push(`Bundles sum ${sum}% (must be 100%)`);
      if (outOfRange) errors.push('Bundle percentage out of [0..100]');
      if (unknownMuscles.length) errors.push(`Unknown muscles: ${Array.from(new Set(unknownMuscles)).join(', ')}`);

      const ok = errors.length === 0;
      if (!ok) setStatus('bad', errors[0]);
      else if (warnings.length) setStatus('warn', warnings[0]);
      else setStatus('ok', 'Valid');
      els.saveBtn.disabled = !ok;

      if (!els.editor.hasAttribute('hidden')) els.editor.value = pretty(ent);
      return {ok, errors, warnings};
    }

    // ===== GPT prompt =====
    function buildGptPrompt(){
      const lines = [];
      lines.push('Task: Improve the following Exercise Example JSON. Return ONLY valid JSON (no markdown, no commentary).');
      lines.push('');
      lines.push('Constraints (STRICT):');
      lines.push('Schema: { id?: string, name: string, description: string, weightType: "free"|"fixed"|"body_weight", category: "compound"|"isolation",');
      lines.push('  experience: "beginner"|"intermediate"|"advanced"|"pro", forceType: "push"|"pull"|"hinge", imageUrl?: string,');
      lines.push(`  ${FIELD.bundles}: [{ muscleId: string, percentage: number }], ${FIELD.equipmentRefs}: [{ equipmentId: string }], tutorials: [] }`);
      lines.push('- Do not change `id` if present.');
      lines.push(`- "${FIELD.bundles}" total "percentage" MUST be exactly 100.`);
      lines.push(`- "${FIELD.equipmentRefs}" MUST use valid equipment IDs from the dictionary below.`);
      lines.push('- Improve quality if needed (e.g., muscle ratios), but keep logical consistency and existing relations. Do NOT break database constraints.');
      lines.push('');
      lines.push('Muscles dictionary (name — id):');
      for (const [id,name] of dict.muscles.entries()) lines.push(`- ${name} — ${id}`);
      lines.push('');
      lines.push('Equipment dictionary (name — id):');
      for (const [id,name] of dict.equipment.entries()) lines.push(`- ${name} — ${id}`);
      lines.push('');
      lines.push('Current JSON:'); lines.push(pretty(getEntity()));
      lines.push(''); lines.push('Return: ONLY the final JSON (no code fences).');
      return lines.join('\n');
    }
    async function copyPrompt(){
      const prompt = buildGptPrompt();
      try{ await navigator.clipboard.writeText(prompt); toast({title:'Prompt copied'}); }
      catch(e){
        const ta=document.createElement('textarea'); ta.value=prompt; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove(); toast({title:'Prompt copied'});
      }
    }

    // ===== View switching =====
    function setViewForm(){
      els.viewForm.classList.add('active'); els.viewJson.classList.remove('active');
      els.builder.classList.add('show'); els.editor.hidden = true;
    }
    function setViewJson(){
      els.viewJson.classList.add('active'); els.viewForm.classList.remove('active');
      els.builder.classList.remove('show'); els.editor.hidden = false;
      els.editor.value = pretty(getEntity());
    }

    // ===== Bootstrap =====
    window.addEventListener('DOMContentLoaded', async ()=>{
      els.token.value = loadTokenLocal();

      await Promise.all([fetchEquipmentDict(), fetchMuscleDict()]);
      rebuildNameIndexes();
      refreshOptionLists();

      // Sidebar
      els.load.addEventListener('click', loadList);
      els.search.addEventListener('input', applySearch);
      els.clearSearch.addEventListener('click', ()=>{ els.search.value=''; applySearch(); });
      els.newBtn.addEventListener('click', newItem);

      // Header actions
      els.saveToken.addEventListener('click', ()=>{ saveTokenLocal(els.token.value); toast({title:'Token saved'}); });
      els.saveBtn.addEventListener('click', saveCurrent);
      els.formatBtn.addEventListener('click', ()=>{
        try{ const obj = JSON.parse(els.editor.value); els.editor.value = pretty(obj); validateAll(); }
        catch(e){ toast({title:'Format error', message:String(e.message||e), type:'error'}); }
      });
      els.copyEntityBtn.addEventListener('click', ()=> copyToClipboard(els.editor.value, 'Editor JSON copied'));
      els.copyFullBtn.addEventListener('click', ()=>{
        if (!current){ toast({title:'Nothing selected', type:'error'}); return; }
        copyToClipboard(pretty(current), 'Full item JSON copied');
      });
      els.promptBtn.addEventListener('click', copyPrompt);

      // View
      els.viewForm.addEventListener('click', setViewForm);
      els.viewJson.addEventListener('click', setViewJson);

      // Form inputs
      [els.fName, els.fImage, els.fDescription].forEach(input=> input.addEventListener('input', ()=>{ setEntity(readFormToEntity(getEntity())); }));
      [els.fWeightType, els.fCategory, els.fExperience, els.fForceType].forEach(sel=> sel.addEventListener('change', ()=>{ setEntity(readFormToEntity(getEntity())); }));

      // Equipment actions
      els.equipAdd.addEventListener('click', addSelectedEquipments);
      els.equipClear.addEventListener('click', ()=>{
        const ent=getEntity(); ent[FIELD.equipmentRefs]=[]; setEntity(ent);
      });

      // Bundles actions
      els.bundleAdd.addEventListener('click', addBundleFromInputs);
      els.percentInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addBundleFromInputs(); } });

      // JSON normalize
      els.editor.addEventListener('input', ()=>{
        try{
          const obj = JSON.parse(els.editor.value);
          canonical = normalizeEntityShape(obj);
          writeEntityToForm(canonical);
          validateAll();
        }catch{
          setStatus('bad','Invalid JSON'); els.saveBtn.disabled = true;
        }
      });

      // Start empty
      setEntity(emptyTemplate());
      setViewForm();
    });

    async function copyToClipboard(text, label='Copied'){
      try{ await navigator.clipboard.writeText(text); toast({title:label}); }
      catch(e){
        const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove(); toast({title:label});
      }
    }

    // CORS hint wrapper
    (function patchFetchForHints(){
      const orig = window.fetch;
      window.fetch = async (...args)=>{
        try{ return await orig(...args); }
        catch(e){
          toast({
            title:'Network error',
            message:'If you see this on GitHub Pages, enable CORS on grippo-app.com for GET, POST, PUT and header Authorization.',
            type:'error', ms:8000
          });
          throw e;
        }
      };
    })();
  </script>
</body>
</html>
