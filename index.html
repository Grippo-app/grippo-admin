<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grippo Admin — Exercise Examples</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#111827;--panel-2:#0f172a;--text:#e5e7eb;--muted:#94a3b8;
      --brand:#60a5fa;--brand-2:#38bdf8;--danger:#ef4444;--ok:#22c55e;--border:#1f2937;
      --warning:#f59e0b;--shadow:0 8px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0a0f1a);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    header{position:sticky;top:0;z-index:20;backdrop-filter:blur(6px);background:color-mix(in srgb,var(--panel) 92%,transparent);
      border-bottom:1px solid var(--border);padding:10px 14px;display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;box-shadow:var(--shadow)}
    nav.tabs{position:sticky;top:58px;z-index:19;background:color-mix(in srgb,var(--panel) 92%,transparent);border-bottom:1px solid var(--border);
      display:flex;gap:8px;padding:8px 12px}
    .tab{border:1px solid var(--border);background:var(--panel-2);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
    .tab.active{outline:2px solid var(--brand)}
    .tab.disabled{opacity:.5;cursor:not-allowed}
    .token-input{width:100%}
    input[type="password"],input[type="text"],input[type="search"],input[type="url"],select,textarea{
      width:100%;background:var(--panel-2);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px;outline:none}
    input::placeholder,textarea::placeholder{color:var(--muted)}
    .btn{background:linear-gradient(90deg,var(--brand),var(--brand-2));border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow);transition:transform .05s;font-weight:600}
    .btn.muted{background:var(--panel-2);color:var(--text);border:1px solid var(--border);box-shadow:none}
    .btn.warn{background:var(--warning);color:#111}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn:active{transform:translateY(1px)}
    main{display:grid;grid-template-columns:340px 1fr;gap:12px;padding:12px;height:calc(100% - 104px)}
    @media (max-width:1000px){main{grid-template-columns:1fr;height:auto}}
    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;min-height:0}
    .side-head{padding:12px;display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;border-bottom:1px solid var(--border)}
    .list{overflow:auto;padding:8px;display:grid;gap:8px}
    .item{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px;cursor:pointer;display:grid;gap:4px}
    .item:hover{border-color:#2b394f}.item.active{outline:2px solid var(--brand)}
    .name{font-weight:600}.meta{color:var(--muted);font-size:12px;display:flex;gap:10px;align-items:center}
    .pill{background:#0b253d;color:#9dd1ff;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #123756}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;min-height:0}
    .ed-head{padding:10px;display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .spacer{flex:1}
    .status{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel-2)}
    .status.ok{color:#d1fae5;background:#08351a;border-color:#14532d}
    .status.bad{color:#fee2e2;background:#3a0d0d;border-color:#7f1d1d}
    .status.warn{color:#fff7ed;background:#3a270b;border-color:#92400e}

    .view-toggle{display:flex;gap:8px;margin-left:auto}
    .segment{background:var(--panel-2);border:1px solid var(--border);border-radius:10px;padding:6px;display:inline-flex;gap:6px}
    .segment .seg{background:transparent;border:0;color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer}
    .segment .seg.active{background:var(--panel);border:1px solid var(--border)}

    .builder{padding:12px;display:none}.builder.show{display:block}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .three{grid-template-columns:1fr 1fr 1fr}
    .field{display:grid;gap:6px}
    .field label{font-weight:600}
    .hint{font-size:12px;color:var(--muted)}
    .invalid{border-color:#7f1d1d !important;box-shadow:inset 0 0 0 1px #7f1d1d}
    .token-list{display:flex;flex-wrap:wrap;gap:6px}
    .token{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;background:#0b253d;color:#9dd1ff;border:1px solid #123756;border-radius:999px;font-size:12px}
    .token button{background:transparent;border:0;color:#9dd1ff;cursor:pointer;font-size:14px;line-height:1}
    .token.invalid{border-color:#7f1d1d;color:#fecaca;background:#3a0d0d}
    .bundle-row{display:grid;grid-template-columns:1.6fr 0.6fr auto;gap:8px;align-items:center}
    .sum{font-size:12px}
    .sum.bad{color:#fca5a5}.sum.ok{color:#86efac}

    textarea#editor{width:100%;height:100%;flex:1;resize:none;border:0;outline:none;padding:14px;background:#0a1324;color:#dbeafe;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px;line-height:1.45;border-bottom-left-radius:14px;border-bottom-right-radius:14px}

    .toast{position:fixed;right:16px;bottom:16px;background:var(--panel-2);border:1px solid var(--border);color:var(--text);
      padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);min-width:220px;display:grid;gap:6px}
    .toast.success{border-color:#155e31;background:#0a2a18}
    .toast.error{border-color:#7f1d1d;background:#3a0d0d}
    .toast .title{font-weight:700}
  </style>
</head>
<body>
  <!-- Top bar with token and actions -->
  <header>
    <div class="token-input">
      <input id="token" type="password" placeholder="Bearer token (stored locally)" autocomplete="off"/>
    </div>
    <button id="saveToken" class="btn muted" title="Save token to localStorage">Save token</button>
    <button id="loadBtn" class="btn" title="Fetch list from API">Load list</button>
  </header>

  <!-- Admin modules tabs (future-proof) -->
  <nav class="tabs" role="tablist" aria-label="Admin modules">
    <button class="tab active" id="tab-examples" role="tab" aria-selected="true">Exercise Examples</button>
    <button class="tab disabled" role="tab" aria-selected="false" title="Coming soon" disabled>Rewards</button>
    <button class="tab disabled" role="tab" aria-selected="false" title="Coming soon" disabled>Chores</button>
    <button class="tab disabled" role="tab" aria-selected="false" title="Coming soon" disabled>Blackouts</button>
  </nav>

  <main>
    <!-- Sidebar -->
    <section class="sidebar" aria-label="Examples list">
      <div class="side-head">
        <input id="search" type="search" placeholder="Search by name…"/>
        <button id="newBtn" class="btn warn" title="Create new exercise example">New</button>
        <button id="clearSearch" class="btn muted" title="Clear">×</button>
      </div>
      <div id="list" class="list" role="listbox" aria-label="Exercise examples list"></div>
    </section>

    <!-- Editor panel -->
    <section class="panel">
      <div class="ed-head">
        <span id="currentId" class="hint">No item selected</span>
        <span class="spacer"></span>
        <span id="jsonStatus" class="status warn">Waiting…</span>

        <div class="view-toggle">
          <div class="segment" role="tablist" aria-label="Editor mode">
            <button id="viewForm" class="seg active" role="tab" aria-selected="true" title="Form builder">Form</button>
            <button id="viewJson" class="seg" role="tab" aria-selected="false" title="Raw JSON">JSON</button>
          </div>
        </div>

        <button id="formatBtn" class="btn muted" title="Prettify JSON">Format</button>
        <button id="copyEntityBtn" class="btn muted" title="Copy editor JSON">Copy editor JSON</button>
        <button id="copyFullBtn" class="btn muted" title="Copy full item (entity + stats)">Copy full JSON</button>
        <button id="promptBtn" class="btn" title="Build GPT prompt from dictionaries + current JSON">Build GPT prompt</button>
        <button id="saveBtn" class="btn" disabled title="Save changes">Save</button>
      </div>

      <!-- FORM BUILDER -->
      <div id="builder" class="builder show" aria-label="Exercise Example Builder">
        <div class="grid two">
          <div class="field">
            <label for="fName">Name *</label>
            <input id="fName" type="text" placeholder="e.g., Front Foot Elevated Smith Machine Split Squat"/>
          </div>
          <div class="field">
            <label for="fImage">Image URL</label>
            <input id="fImage" type="url" placeholder="https://..."/>
          </div>
        </div>

        <div class="field">
          <label for="fDescription">Description *</label>
          <textarea id="fDescription" rows="3" placeholder="Short description..."></textarea>
        </div>

        <div class="grid three">
          <div class="field">
            <label for="fWeightType">Weight type *</label>
            <input id="fWeightType" list="listWeight" placeholder="free / machine / bodyweight / cable"/>
            <datalist id="listWeight">
              <option value="free"/><option value="machine"/><option value="bodyweight"/><option value="cable"/><option value="band"/>
            </datalist>
          </div>
          <div class="field">
            <label for="fCategory">Category *</label>
            <input id="fCategory" list="listCategory" placeholder="compound / isolation"/>
            <datalist id="listCategory">
              <option value="compound"/><option value="isolation"/>
            </datalist>
          </div>
          <div class="field">
            <label for="fExperience">Experience *</label>
            <input id="fExperience" list="listExperience" placeholder="beginner / intermediate / advanced"/>
            <datalist id="listExperience">
              <option value="beginner"/><option value="intermediate"/><option value="advanced"/>
            </datalist>
          </div>
        </div>

        <div class="grid two">
          <div class="field">
            <label for="fForceType">Force type *</label>
            <input id="fForceType" list="listForce" placeholder="push / pull / static"/>
            <datalist id="listForce">
              <option value="push"/><option value="pull"/><option value="static"/>
            </datalist>
          </div>
          <div class="field">
            <label>ID (locked for existing)</label>
            <input id="fId" type="text" disabled placeholder="Auto for new, locked for existing"/>
            <div class="hint">ID cannot be changed for existing items.</div>
          </div>
        </div>

        <hr style="border:0;border-top:1px solid var(--border);margin:8px 0"/>

        <div class="field">
          <label>Equipment *</label>
          <div id="equipTokens" class="token-list" aria-live="polite"></div>
          <div class="grid two">
            <div class="field">
              <input id="equipInput" list="equipOptions" placeholder="Search equipment by name or paste ID"/>
              <datalist id="equipOptions"></datalist>
            </div>
            <button id="equipAdd" class="btn" type="button">Add</button>
          </div>
          <div class="hint">Using backend dictionary. Unknown IDs are highlighted and block saving.</div>
        </div>

        <div class="field">
          <label>Muscle bundles (sum must be 100%) *</label>
          <div id="bundles"></div>
          <div class="bundle-row">
            <input id="muscleInput" list="muscleOptions" placeholder="Search muscle or paste ID"/>
            <datalist id="muscleOptions"></datalist>
            <input id="percentInput" type="number" min="0" max="100" step="1" placeholder="%"/>
            <button id="bundleAdd" class="btn" type="button">Add bundle</button>
          </div>
          <div id="bundleSumInfo" class="sum">Sum: 0%</div>
        </div>
      </div>

      <!-- RAW JSON -->
      <textarea id="editor" spellcheck="false" hidden></textarea>
    </section>
  </main>

  <template id="itemTemplate">
    <div class="item" role="option" tabindex="0">
      <div class="name"></div>
      <div class="meta">
        <span class="pill usage"></span>
        <span class="lastUsed"></span>
      </div>
    </div>
  </template>

  <script>
    // ===== Configuration =====
    const API_BASE = 'https://grippo-app.com';
    const LIST_ENDPOINT   = `${API_BASE}/exercise-examples`;
    const CREATE_ENDPOINT = `${API_BASE}/exercise-examples`; // POST
    const PUT_ENDPOINT    = (id) => `${API_BASE}/exercise-examples?id=${encodeURIComponent(id)}`;

    // Public dictionaries (no auth)
    const EQUIPMENT_GROUPS_ENDPOINT = `${API_BASE}/equipments`;
    const MUSCLE_GROUPS_ENDPOINT    = `${API_BASE}/muscles`;

    // ===== State =====
    let items = [];      // Array<ExerciseExampleWithStatsResponse>
    let filtered = [];   // shown in left list
    let current = null;  // currently selected item (with .entity)
    let isNew = false;   // editing brand-new template

    // Canonical keys used by builder (simple and safe)
    const FIELD = {
      equipment: 'equipmentRefs',                // string[] of equipment IDs
      bundles: 'exerciseExampleBundles',         // { muscleId: string, percent: number }[]
      muscleKey: 'muscleId',
      percentKey: 'percent'
    };

    // Dictionaries
    const dict = {
      equipment: new Map(), // id -> name
      muscles: new Map(),   // id -> name
    };

    // ===== Elements =====
    const els = {
      token: document.getElementById('token'),
      saveToken: document.getElementById('saveToken'),
      load: document.getElementById('loadBtn'),

      tabExamples: document.getElementById('tab-examples'),

      list: document.getElementById('list'),
      search: document.getElementById('search'),
      clearSearch: document.getElementById('clearSearch'),
      newBtn: document.getElementById('newBtn'),

      // Status & actions
      currentId: document.getElementById('currentId'),
      jsonStatus: document.getElementById('jsonStatus'),
      saveBtn: document.getElementById('saveBtn'),
      formatBtn: document.getElementById('formatBtn'),
      copyEntityBtn: document.getElementById('copyEntityBtn'),
      copyFullBtn: document.getElementById('copyFullBtn'),
      promptBtn: document.getElementById('promptBtn'),

      // Builder vs JSON
      viewForm: document.getElementById('viewForm'),
      viewJson: document.getElementById('viewJson'),
      builder: document.getElementById('builder'),
      editor: document.getElementById('editor'),

      // Basics
      fName: document.getElementById('fName'),
      fImage: document.getElementById('fImage'),
      fDescription: document.getElementById('fDescription'),
      fWeightType: document.getElementById('fWeightType'),
      fCategory: document.getElementById('fCategory'),
      fExperience: document.getElementById('fExperience'),
      fForceType: document.getElementById('fForceType'),
      fId: document.getElementById('fId'),

      // Equipment
      equipTokens: document.getElementById('equipTokens'),
      equipInput: document.getElementById('equipInput'),
      equipOptions: document.getElementById('equipOptions'),
      equipAdd: document.getElementById('equipAdd'),

      // Bundles
      bundles: document.getElementById('bundles'),
      muscleInput: document.getElementById('muscleInput'),
      muscleOptions: document.getElementById('muscleOptions'),
      percentInput: document.getElementById('percentInput'),
      bundleAdd: document.getElementById('bundleAdd'),
      bundleSumInfo: document.getElementById('bundleSumInfo'),

      itemTemplate: document.getElementById('itemTemplate'),
    };

    // ===== Utilities =====
    function toast({title, message = '', type = 'success', ms = 3000}) {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<div class="title">${title}</div>${message ? `<div>${message}</div>` : ''}`;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), ms);
    }
    function saveTokenLocal(v){ localStorage.setItem('grippo_admin_token', v || ''); }
    function loadTokenLocal(){ return localStorage.getItem('grippo_admin_token') || ''; }
    function bearer(){ const tok = els.token.value.trim(); return tok ? {'Authorization': `Bearer ${tok}`} : {}; }
    function pretty(json){ return JSON.stringify(json, null, 2); }
    function formatIso(d){ try{ return new Date(d).toISOString().replace('T',' ').replace('Z','Z'); }catch{ return String(d); } }
    function setStatus(kind, text){ els.jsonStatus.className = `status ${kind}`; els.jsonStatus.textContent = text; }

    function uuidv4(){
      if (crypto?.randomUUID) return crypto.randomUUID();
      // Fallback
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
        const r = (Math.random()*16)|0, v = c==='x'?r:(r&0x3|0x8);
        return v.toString(16);
      });
    }

    // ===== Dictionaries =====
    async function fetchEquipmentDict(){
      try{
        const resp = await fetch(EQUIPMENT_GROUPS_ENDPOINT, {headers:{accept:'application/json'}});
        if(!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
        const data = await resp.json();
        const equipments = [];
        if (Array.isArray(data) && data.length && Array.isArray(data[0]?.equipments)){
          data.forEach(g => (g.equipments||[]).forEach(e => equipments.push(e)));
        } else if (Array.isArray(data)){
          data.forEach(e => equipments.push(e));
        }
        for (const e of equipments){
          if (e?.id) dict.equipment.set(String(e.id), String(e.name ?? e.id));
        }
      }catch(e){ console.warn('Equipment dict fetch failed:', e); }
    }
    async function fetchMuscleDict(){
      try{
        const resp = await fetch(MUSCLE_GROUPS_ENDPOINT, {headers:{accept:'application/json'}});
        if(!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
        const data = await resp.json();
        if (Array.isArray(data)){
          for (const g of data){
            (g.muscles||[]).forEach(m => { if (m?.id) dict.muscles.set(String(m.id), String(m.name ?? m.id)); });
          }
        }
      }catch(e){ console.warn('Muscle dict fetch failed:', e); }
    }
    function refreshOptionLists(){
      els.equipOptions.innerHTML = '';
      for (const [id,name] of dict.equipment.entries()){
        const opt = document.createElement('option'); opt.value = id; opt.label = name; els.equipOptions.appendChild(opt);
      }
      els.muscleOptions.innerHTML = '';
      for (const [id,name] of dict.muscles.entries()){
        const opt = document.createElement('option'); opt.value = id; opt.label = name; els.muscleOptions.appendChild(opt);
      }
    }

    // ===== List rendering =====
    function renderList(){
      els.list.innerHTML = '';
      const frag = document.createDocumentFragment();
      filtered.forEach(it=>{
        const node = els.itemTemplate.content.firstElementChild.cloneNode(true);
        const entity = it.entity;
        node.querySelector('.name').textContent = entity?.name || '(no name)';
        node.querySelector('.usage').textContent = `used ${it.usageCount ?? 0}`;
        node.querySelector('.lastUsed').textContent = it.lastUsed ? `last: ${formatIso(it.lastUsed)}` : 'last: —';
        node.addEventListener('click', ()=>selectItem(it));
        node.addEventListener('keydown', e=>{
          if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectItem(it); }
        });
        if (current && current.entity?.id === entity?.id) node.classList.add('active');
        frag.appendChild(node);
      });
      els.list.appendChild(frag);
    }
    function applySearch(){
      const q = els.search.value.trim().toLowerCase();
      filtered = !q ? items.slice() : items.filter(it => (it.entity?.name || '').toLowerCase().includes(q));
      renderList();
    }

    // ===== Form <-> JSON sync =====
    function emptyTemplate(){
      return {
        id: uuidv4(),
        name: '',
        description: '',
        weightType: '',
        category: '',
        experience: '',
        forceType: '',
        imageUrl: '',
        [FIELD.equipment]: [],         // string[] of equipment IDs
        [FIELD.bundles]: [],           // { muscleId, percent }[]
        tutorials: []                  // keep as array; backend can ignore if not used
      };
    }

    function readFormToEntity(entity){
      const e = {...entity};
      e.name = els.fName.value.trim();
      e.imageUrl = els.fImage.value.trim();
      e.description = els.fDescription.value.trim();
      e.weightType = els.fWeightType.value.trim();
      e.category = els.fCategory.value.trim();
      e.experience = els.fExperience.value.trim();
      e.forceType = els.fForceType.value.trim();
      // equipment and bundles already kept in e via token/bundle handlers
      if (!Array.isArray(e.tutorials)) e.tutorials = [];
      return e;
    }

    function writeEntityToForm(entity){
      els.fId.value = entity?.id || '';
      els.fName.value = entity?.name || '';
      els.fImage.value = entity?.imageUrl || '';
      els.fDescription.value = entity?.description || '';
      els.fWeightType.value = entity?.weightType || '';
      els.fCategory.value = entity?.category || '';
      els.fExperience.value = entity?.experience || '';
      els.fForceType.value = entity?.forceType || '';

      renderEquipmentTokens(entity);
      renderBundles(entity);
    }

    function getParsedEditorEntity(){
      try{ return JSON.parse(els.editor.value) || {}; }catch{ return {}; }
    }
    function setEditorFromEntity(e){
      els.editor.value = pretty(e);
      validateAll();
    }

    // ===== Equipment (string[] of IDs) =====
    function renderEquipmentTokens(entity){
      const eq = Array.isArray(entity[FIELD.equipment]) ? entity[FIELD.equipment] : [];
      els.equipTokens.innerHTML = '';
      const frag = document.createDocumentFragment();
      eq.forEach((id, idx)=>{
        const name = dict.equipment.get(String(id)) || String(id);
        const t = document.createElement('span');
        t.className = 'token';
        if (!dict.equipment.has(String(id))) t.classList.add('invalid');
        t.innerHTML = `<span>${name}</span>`;
        const btn = document.createElement('button'); btn.type='button'; btn.textContent='×'; btn.title='Remove';
        btn.addEventListener('click', ()=>{
          const ent = getEntity(); // current canonical entity
          const arr = ent[FIELD.equipment] || [];
          arr.splice(idx,1);
          ent[FIELD.equipment] = arr;
          setEntity(ent);
        });
        t.appendChild(btn); frag.appendChild(t);
      });
      els.equipTokens.appendChild(frag);
    }
    function addEquipmentFromInput(){
      const raw = els.equipInput.value.trim();
      if (!raw) return;
      const ent = getEntity();
      if (!Array.isArray(ent[FIELD.equipment])) ent[FIELD.equipment] = [];
      if (!ent[FIELD.equipment].includes(raw)){
        ent[FIELD.equipment].push(raw);
        setEntity(ent);
      }
      els.equipInput.value = '';
    }

    // ===== Bundles (array of { muscleId, percent }) =====
    function renderBundles(entity){
      const arr = Array.isArray(entity[FIELD.bundles]) ? entity[FIELD.bundles] : [];
      els.bundles.innerHTML = '';
      const frag = document.createDocumentFragment();
      let sum = 0;

      arr.forEach((b, i)=>{
        const row = document.createElement('div'); row.className='bundle-row';

        const muscle = document.createElement('input');
        muscle.placeholder = 'Muscle ID or name…'; muscle.setAttribute('list','muscleOptions');
        muscle.value = String(b?.[FIELD.muscleKey] || '');
        if (!dict.muscles.has(String(muscle.value))) muscle.classList.add('invalid');

        const percent = document.createElement('input');
        percent.type='number'; percent.min='0'; percent.max='100'; percent.step='1';
        const p = Number(b?.[FIELD.percentKey] ?? 0); percent.value = String(p);
        if (!isFinite(p) || p<0 || p>100) percent.classList.add('invalid');
        sum += isFinite(p) ? p : 0;

        const del = document.createElement('button'); del.className='btn muted'; del.type='button'; del.textContent='Remove';

        muscle.addEventListener('input', ()=>{
          const ent = getEntity();
          ent[FIELD.bundles][i][FIELD.muscleKey] = muscle.value.trim();
          setEntity(ent);
        });
        percent.addEventListener('change', ()=>{
          const ent = getEntity();
          ent[FIELD.bundles][i][FIELD.percentKey] = Number(percent.value || 0);
          setEntity(ent);
        });
        del.addEventListener('click', ()=>{
          const ent = getEntity();
          ent[FIELD.bundles].splice(i,1);
          setEntity(ent);
        });

        row.appendChild(muscle); row.appendChild(percent); row.appendChild(del);
        frag.appendChild(row);
      });

      els.bundles.appendChild(frag);
      els.bundleSumInfo.textContent = `Sum: ${sum}%`;
      els.bundleSumInfo.className = 'sum ' + (sum===100?'ok':'bad');
    }
    function addBundleFromInputs(){
      const m = els.muscleInput.value.trim();
      const p = Number(els.percentInput.value || 0);
      if (!m || !isFinite(p)) return;
      const ent = getEntity();
      if (!Array.isArray(ent[FIELD.bundles])) ent[FIELD.bundles] = [];
      ent[FIELD.bundles].push({[FIELD.muscleKey]: m, [FIELD.percentKey]: p});
      setEntity(ent);
      els.muscleInput.value=''; els.percentInput.value='';
    }

    // ===== Entity source of truth =====
    // We keep one canonical entity object mirrored in both Form and JSON views.
    let canonical = emptyTemplate();

    function getEntity(){ return {...canonical}; }
    function setEntity(newEnt){
      canonical = {...newEnt};
      // Push to form and JSON view
      writeEntityToForm(canonical);
      els.editor.value = pretty(canonical);
      validateAll();
    }

    // ===== Selection & CRUD =====
    function selectItem(it){
      current = it; isNew = false;
      const e = it.entity || emptyTemplate();
      canonical = {...e};
      els.currentId.textContent = e?.id ? `Editing ID: ${e.id}` : 'Editing: unknown ID';
      writeEntityToForm(canonical);
      els.editor.value = pretty(canonical);
      validateAll();
      renderList();
    }
    function newItem(){
      current = null; isNew = true;
      canonical = emptyTemplate();
      els.currentId.textContent = `Creating new ID: ${canonical.id}`;
      writeEntityToForm(canonical);
      els.editor.value = pretty(canonical);
      validateAll();
    }

    async function loadList(){
      const headers = {accept:'application/json', ...bearer()};
      if (!headers.Authorization){
        toast({title:'Token required', message:'Set a valid Bearer token first.', type:'error', ms:3500}); return;
      }
      els.load.disabled = true;
      try{
        const resp = await fetch(LIST_ENDPOINT, {headers, method:'GET'});
        if(!resp.ok){
          const text = await resp.text(); throw new Error(`${resp.status} ${resp.statusText} — ${text.slice(0,300)}`);
        }
        const data = await resp.json();
        if(!Array.isArray(data)) throw new Error('Unexpected response shape: expected an array');
        items = data; filtered = items.slice();
        renderList(); toast({title:'Loaded', message:`Items: ${items.length}`});
      }catch(e){
        toast({title:'Load failed', message:String(e.message||e), type:'error', ms:6000}); console.error(e);
      }finally{ els.load.disabled = false; }
    }

    async function saveCurrent(){
      const headers = {'accept':'application/json','content-type':'application/json', ...bearer()};
      if (!headers.Authorization){ toast({title:'Token required', message:'Set a valid Bearer token first.', type:'error'}); return; }

      // Read form to canonical and validate
      const ent = readFormToEntity(getEntity());
      setEntity(ent); // sync & revalidate
      const {ok} = validateAll();
      if (!ok){ toast({title:'Fix validation errors', type:'error'}); return; }

      els.saveBtn.disabled = true;
      try{
        if (isNew){
          // Create
          let resp = await fetch(CREATE_ENDPOINT, {method:'POST', headers, body: JSON.stringify(canonical)});
          if (!resp.ok){
            // Fallback: some APIs accept PUT to specific id for create
            resp = await fetch(PUT_ENDPOINT(canonical.id), {method:'PUT', headers, body: JSON.stringify(canonical)});
          }
          if (!resp.ok){
            const text = await resp.text(); throw new Error(`${resp.status} ${resp.statusText} — ${text.slice(0,400)}`);
          }
          toast({title:'Created', message:`ID ${canonical.id}`});
          isNew = false;
          // Reload list to include the new item
          await loadList();
        }else{
          // Update — lock ID to original
          canonical.id = current?.entity?.id || canonical.id;
          const id = canonical.id;
          const resp = await fetch(PUT_ENDPOINT(id), {method:'PUT', headers, body: JSON.stringify(canonical)});
          if (!resp.ok){
            const text = await resp.text(); throw new Error(`${resp.status} ${resp.statusText} — ${text.slice(0,400)}`);
          }
          toast({title:'Saved', message:`ID ${id} updated.`});
          // Update in-memory
          if (current) current.entity = {...canonical};
          renderList();
        }
      }catch(e){
        toast({title:'Save failed', message:String(e.message||e), type:'error', ms:7000}); console.error(e);
      }finally{ els.saveBtn.disabled = false; }
    }

    // ===== Validation =====
    function validateAll(){
      // Hard requirements
      const ent = getEntity();
      const missing = [];
      if (!ent.name) missing.push('name');
      if (!ent.description) missing.push('description');
      if (!ent.weightType) missing.push('weightType');
      if (!ent.category) missing.push('category');
      if (!ent.experience) missing.push('experience');
      if (!ent.forceType) missing.push('forceType');

      // equipment known ids
      const eq = Array.isArray(ent[FIELD.equipment]) ? ent[FIELD.equipment] : [];
      const unknownEq = eq.filter(id => !dict.equipment.has(String(id)));

      // bundles total and known ids
      const bundles = Array.isArray(ent[FIELD.bundles]) ? ent[FIELD.bundles] : [];
      let sum = 0, outOfRange = false;
      const unknownMuscles = [];
      for (const b of bundles){
        const id = String(b?.[FIELD.muscleKey] ?? '');
        const p  = Number(b?.[FIELD.percentKey] ?? 0);
        if (!isFinite(p) || p<0 || p>100) outOfRange = true;
        sum += isFinite(p)? p : 0;
        if (!dict.muscles.has(id)) unknownMuscles.push(id);
      }

      // status + save availability
      const hardErrors = [];
      if (missing.length) hardErrors.push(`Missing: ${missing.join(', ')}`);
      if (eq.length === 0) hardErrors.push('No equipment selected');
      if (bundles.length === 0) hardErrors.push('No muscle bundles added');
      if (sum !== 100) hardErrors.push(`Bundles sum ${sum}% (must be 100%)`);
      if (outOfRange) hardErrors.push('Bundle percent out of [0..100]');
      if (unknownEq.length) hardErrors.push(`Unknown equipment: ${Array.from(new Set(unknownEq)).join(', ')}`);
      if (unknownMuscles.length) hardErrors.push(`Unknown muscles: ${Array.from(new Set(unknownMuscles)).join(', ')}`);

      const ok = hardErrors.length === 0;
      setStatus(ok ? 'ok' : 'bad', ok ? 'Valid' : hardErrors[0]);
      els.saveBtn.disabled = !ok;

      // also mirror entity into JSON textarea when JSON view opened
      if (!els.editor.hasAttribute('hidden')) els.editor.value = pretty(ent);

      return {ok, errors: hardErrors};
    }

    // ===== Prompt builder for GPT =====
    function buildGptPrompt(){
      const lines = [];

      lines.push('Task: Improve the following Exercise Example JSON. Return ONLY valid JSON (no markdown, no commentary).');
      lines.push('');
      lines.push('Requirements:');
      lines.push('- Keep the exact JSON structure and field names. Do not add or remove top-level fields unless empty arrays are allowed.');
      lines.push('- Do not change `id`.');
      lines.push(`- \`${FIELD.equipment}\` must contain valid equipment IDs from the dictionary below.`);
      lines.push(`- \`${FIELD.bundles}\` must be an array of { "${FIELD.muscleKey}": string, "${FIELD.percentKey}": number } with the total percent = 100.`);
      lines.push('- Adjust percentages or selections to improve quality if needed, but keep the exercise logically consistent.');
      lines.push('- Do not break database constraints or existing relations.');
      lines.push('');

      // Dictionaries
      lines.push('Muscles dictionary (name — id):');
      for (const [id,name] of dict.muscles.entries()){
        lines.push(`- ${name} — ${id}`);
      }
      lines.push('');
      lines.push('Equipment dictionary (name — id):');
      for (const [id,name] of dict.equipment.entries()){
        lines.push(`- ${name} — ${id}`);
      }
      lines.push('');

      // Current JSON
      lines.push('Current JSON:');
      lines.push(pretty(getEntity()));
      lines.push('');
      lines.push('Return: ONLY the final JSON (no code fences).');

      return lines.join('\n');
    }

    async function copyPrompt(){
      const prompt = buildGptPrompt();
      try{
        await navigator.clipboard.writeText(prompt);
        toast({title:'Prompt copied'});
      }catch(e){
        const ta = document.createElement('textarea');
        ta.value = prompt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
        toast({title:'Prompt copied'});
      }
    }

    // ===== View switching =====
    function setViewForm(){
      els.viewForm.classList.add('active'); els.viewJson.classList.remove('active');
      els.builder.classList.add('show'); els.editor.hidden = true;
    }
    function setViewJson(){
      els.viewJson.classList.add('active'); els.viewForm.classList.remove('active');
      els.builder.classList.remove('show'); els.editor.hidden = false;
      els.editor.value = pretty(getEntity());
    }

    // ===== Bootstrap =====
    window.addEventListener('DOMContentLoaded', async ()=>{
      els.token.value = loadTokenLocal();

      // Load public dictionaries first
      await Promise.all([fetchEquipmentDict(), fetchMuscleDict()]);
      refreshOptionLists();

      // Wire sidebar
      els.load.addEventListener('click', loadList);
      els.search.addEventListener('input', applySearch);
      els.clearSearch.addEventListener('click', ()=>{ els.search.value=''; applySearch(); });
      els.newBtn.addEventListener('click', newItem);

      // Wire header buttons
      els.saveToken.addEventListener('click', ()=>{ saveTokenLocal(els.token.value); toast({title:'Token saved'}); });
      els.saveBtn.addEventListener('click', saveCurrent);
      els.formatBtn.addEventListener('click', ()=>{
        try{ const obj = JSON.parse(els.editor.value); els.editor.value = pretty(obj); validateAll(); }
        catch(e){ toast({title:'Format error', message:String(e.message||e), type:'error'}); }
      });
      els.copyEntityBtn.addEventListener('click', ()=> copyToClipboard(els.editor.value, 'Editor JSON copied'));
      els.copyFullBtn.addEventListener('click', ()=>{
        if (!current){ toast({title:'Nothing selected', type:'error'}); return; }
        copyToClipboard(pretty(current), 'Full item JSON copied');
      });
      els.promptBtn.addEventListener('click', copyPrompt);

      // Builder events
      els.viewForm.addEventListener('click', setViewForm);
      els.viewJson.addEventListener('click', setViewJson);

      // Basics change handlers -> keep canonical in sync
      [els.fName, els.fImage, els.fDescription, els.fWeightType, els.fCategory, els.fExperience, els.fForceType]
        .forEach(input => input.addEventListener('input', ()=>{
          const ent = readFormToEntity(getEntity()); setEntity(ent);
        }));

      // Equipment
      els.equipAdd.addEventListener('click', addEquipmentFromInput);
      els.equipInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addEquipmentFromInput(); } });

      // Bundles
      els.bundleAdd.addEventListener('click', addBundleFromInputs);
      els.percentInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addBundleFromInputs(); } });

      // JSON editor live-validate
      els.editor.addEventListener('input', ()=>{
        try{
          const obj = JSON.parse(els.editor.value);
          // Enforce canonical keys when user edits JSON
          if (!Array.isArray(obj[FIELD.equipment])) obj[FIELD.equipment] = [];
          if (!Array.isArray(obj[FIELD.bundles])) obj[FIELD.bundles] = [];
          canonical = obj; writeEntityToForm(canonical); validateAll();
        }catch{
          setStatus('bad','Invalid JSON'); els.saveBtn.disabled = true;
        }
      });

      // Default: create new (clear state) or wait for Load
      setEntity(emptyTemplate());
      setViewForm();
    });

    async function copyToClipboard(text, label='Copied'){
      try{ await navigator.clipboard.writeText(text); toast({title:label}); }
      catch(e){
        const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove(); toast({title:label});
      }
    }

    // CORS hint wrapper
    (function patchFetchForHints(){
      const orig = window.fetch;
      window.fetch = async (...args)=>{
        try{ return await orig(...args); }
        catch(e){
          toast({
            title:'Network error',
            message:'If you see this on GitHub Pages, enable CORS on grippo-app.com for GET, POST, PUT and header Authorization.',
            type:'error', ms:8000
          });
          throw e;
        }
      };
    })();
  </script>
</body>
</html>
